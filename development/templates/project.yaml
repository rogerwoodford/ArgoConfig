{{- range .Values.core.namespaces }}
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: {{ .name }}-project
  namespace: argocd
  # Finalizer that ensures that project is not deleted until it is not referenced by any application
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  description: Project for {{ .name }} applications

  sourceRepos:
    - '*'

  destinations:
    - namespace: {{ .name }}
      server: https://kubernetes.default.svc
      name: in-cluster

  clusterResourceWhitelist:
    - group: ""
      kind: Namespace

  namespaceResourceWhitelist:
    - group: apps
      kind: Deployment
    - group: apps
      kind: StatefulSet
    - group: apps
      kind: ReplicaSet
    - group: ""
      kind: Pod
    - group: ""
      kind: Event
    - group: ""
      kind: Service
    - group: ""
      kind: ConfigMap
    - group: batch
      kind: "*"
    {{- if .allowIngress }}
    - group: networking.k8s.io
      kind: Ingress
    {{- end }}
    - group: ""
      kind: Endpoints
    - group: discovery.k8s.io
      kind: EndpointSlice
    - group: secrets-store.csi.x-k8s.io
      kind: SecretProviderClass
    - group: autoscaling
      kind: HorizontalPodAutoscaler
    - group: policy
      kind: PodDisruptionBudget

  # Enables namespace orphaned resource monitoring
  orphanedResources:
    warn: true

##  roles:
##  # A role which provides read-only access to all applications in the project
##  - name: read-only
##    description: Read-only privileges to my-project
##    policies:
##    - p, proj:my-project:read-only, applications, get, my-project/*, allow
##    groups:
##    - my-oidc-group
##
##  # A role which provides sync privileges to only the guestbook-prod application, e.g. to provide
##  # sync privileges to a CI system
##  - name: ci-role
##    description: Sync privileges for guestbook-prod
##    policies:
##    - p, proj:my-project:ci-role, applications, sync, my-project/guestbook-prod, allow
##
##    # NOTE: JWT tokens can only be generated by the API server and the token is not persisted
##    # anywhere by Argo CD. It can be prematurely revoked by removing the entry from this list.
##    jwtTokens:
##    - iat: 1535390316
##
##  # Sync windows restrict when Applications may be synced. https://argo-cd.readthedocs.io/en/stable/user-guide/sync_windows/
##  syncWindows:
##  - kind: allow
##    schedule: '10 1 * * *'
##    duration: 1h
##    applications:
##      - '*-prod'
##    manualSync: true
##  - kind: deny
##    schedule: '0 22 * * *'
##    duration: 1h
##    namespaces:
##      - default
##  - kind: allow
##    schedule: '0 23 * * *'
##    duration: 1h
##    clusters:
##      - in-cluster
##      - cluster1
---
{{- end }}
